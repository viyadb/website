
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="In-Memory Analytical Database">
      
      
      
      
        <link rel="shortcut icon" href="../img/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.10.0">
    
    
      
        <title>Clustering - ViyaDB</title>
      
    
    
      <script src="../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-b6a6d08807.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-23f75ab9c7.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="blue-grey" data-md-color-accent="cyan">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="ViyaDB" class="md-header-nav__button md-logo">
          
            
              <img src="../img/logo.svg" width="24" height="24">
            
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Clustering
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/viyadb/viyadb" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      viyadb/viyadb
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        
          <img src="../img/logo.svg">
        
      
    </div>
    ViyaDB
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/viyadb/viyadb" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      viyadb/viyadb
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../usage/" title="Usage" class="md-nav__link">
      Usage
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../samples/" title="Samples" class="md-nav__link">
      Samples
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Clustering
      </label>
    
    <a href="./" title="Clustering" class="md-nav__link md-nav__link--active">
      Clustering
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" title="Components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul" title="Consul" class="md-nav__link">
    Consul
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker" title="Worker" class="md-nav__link">
    Worker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controller" title="Controller" class="md-nav__link">
    Controller
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running" title="Running" class="md-nav__link">
    Running
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul-configuration" title="Consul configuration" class="md-nav__link">
    Consul configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viyadb-nodes" title="ViyaDB nodes" class="md-nav__link">
    ViyaDB nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-data" title="Loading data" class="md-nav__link">
    Loading data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#querying" title="Querying" class="md-nav__link">
    Querying
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-time-data-processing" title="Real-Time Data Processing" class="md-nav__link">
    Real-Time Data Processing
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../realtime/" title="Realtime" class="md-nav__link">
      Realtime
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" title="Components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul" title="Consul" class="md-nav__link">
    Consul
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker" title="Worker" class="md-nav__link">
    Worker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controller" title="Controller" class="md-nav__link">
    Controller
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running" title="Running" class="md-nav__link">
    Running
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul-configuration" title="Consul configuration" class="md-nav__link">
    Consul configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viyadb-nodes" title="ViyaDB nodes" class="md-nav__link">
    ViyaDB nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-data" title="Loading data" class="md-nav__link">
    Loading data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#querying" title="Querying" class="md-nav__link">
    Querying
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-time-data-processing" title="Real-Time Data Processing" class="md-nav__link">
    Real-Time Data Processing
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="clustering">Clustering<a class="headerlink" href="#clustering" title="Permanent link">&para;</a></h1>
<p>Even though it's possible to run ViyaDB on a single node, it's usually required
to run several database instances in order to be able to:</p>
<ul>
<li>Scale in case aggregated dataset doesn't fit into a single machine's RAM.</li>
<li>Scale out concurrent queries by spreading them between different workers.</li>
<li>Failover on data center failure.</li>
</ul>
<p>This page describes how ViyaDB works when running in a cluster mode.</p>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h2>
<p>ViyaDB implements shared nothing architecture. That means that the data is partitioned
and spread between independent workers.</p>
<p><img alt="Clustering" src="../img/clustering1.png" /></p>
<h2 id="components">Components<a class="headerlink" href="#components" title="Permanent link">&para;</a></h2>
<h3 id="consul">Consul<a class="headerlink" href="#consul" title="Permanent link">&para;</a></h3>
<p>Consul is used as a coordination service as well as for storing cluster configuration.</p>
<p>There were three different options for coordination service at the beginning: <a href="https://zookeeper.apache.org/">Zookeeper</a>,
<a href="https://www.consul.io/">Consul</a> and <a href="https://coreos.com/etcd/">etcd</a>, but the choice was made in favor of Consul for its:</p>
<ul>
<li>Installation and configuration simplicity.</li>
<li>Great Web interface.</li>
<li>Out of the box service registration and lookup support.</li>
</ul>
<h3 id="worker">Worker<a class="headerlink" href="#worker" title="Permanent link">&para;</a></h3>
<p>Worker is a ViyaDB process that keeps a partition of data in RAM. Every such process is
attached to it's own CPU core (using CPU affinity) for achieving better cache locality.</p>
<p>Every worker listens on its own HTTP port, where it provides a service for loading and
querying the data it keeps.</p>
<h3 id="controller">Controller<a class="headerlink" href="#controller" title="Permanent link">&para;</a></h3>
<p>Controller is the main process that launches ViyaDB workers on a single node, and takes
care of keeping them alive. In addition, this process is responsible for coordination
between database nodes using Consul. One of cluster controllers becomes a leader.</p>
<p>Controller can act as query aggregator, which means that it can be queried directly, and
a query will be sent to workers containing required data partitions, then the result
will be combined and returned back to a user.</p>
<p>Communication with workers is performed using HTTP API.</p>
<h2 id="running">Running<a class="headerlink" href="#running" title="Permanent link">&para;</a></h2>
<p>Let's run a cluster of ViyaDB nodes, and load 1 billion of user events into it.</p>
<h3 id="consul-configuration">Consul configuration<a class="headerlink" href="#consul-configuration" title="Permanent link">&para;</a></h3>
<p>First, you must have <a href="https://www.consul.io">Consul</a> installed somewhere.</p>
<p>Create the following two keys in Consul, which represent ViyaDB cluster configuration:</p>
<p><em>viyadb/clusters/cluster001/config</em></p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;replication_factor&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;workers&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
  <span class="nt">&quot;tables&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p><em>viyadb/tables/events/config</em></p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;events&quot;</span><span class="p">,</span>
  <span class="nt">&quot;dimensions&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;app_id&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint&quot;</span><span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;event_time&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
      <span class="nt">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;millis&quot;</span><span class="p">,</span> <span class="nt">&quot;granularity&quot;</span><span class="p">:</span> <span class="s2">&quot;day&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;country&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;city&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;device_type&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;device_vendor&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ad_network&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;campaign&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;site_id&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;event_type&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;event_name&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;organic&quot;</span><span class="p">,</span> <span class="nt">&quot;cardinality&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;days_from_install&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ushort&quot;</span><span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;revenue&quot;</span> <span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;double_sum&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bitset&quot;</span><span class="p">,</span> <span class="nt">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="nt">&quot;max&quot;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span> <span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;partitioning&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;app_id&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="viyadb-nodes">ViyaDB nodes<a class="headerlink" href="#viyadb-nodes" title="Permanent link">&para;</a></h3>
<p>Then, let's launch four AWS EC2 instances of type r4.2xlarge. This instance type has 8 vCPU, which 
will allow us to have 8 workers per host (32 workers in total). This will translate into having
32 partitions if using a single replica per partition.</p>
<p>ViyaDB is built against g++-7, that's why it's easier to use one of Ubuntu Artful (17.10) AMI
provided by Canonical. Make sure, all TCP ports of ViyaDB nodes are open to each other.
Also, make sure thereâ€™s enough disk space for downloading and extracting several tens
of gigabytes of JSON files representing user events.</p>
<p>Once all four machines are running, proceed with the following steps on every one of the nodes.</p>
<p>Install g++-7 by running the following commands:</p>
<div class="codehilite"><pre><span></span>apt-get update
apt-get install g++-7
update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 <span class="m">60</span> --slave /usr/bin/g++ g++ /usr/bin/g++-7
</pre></div>


<p>Create file <code>/etc/viyadb/store.json</code> with the following contents (replace <code>consul-host</code> with real Consul hostname):</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;supervise&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&quot;workers&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
  <span class="nt">&quot;cluster_id&quot;</span><span class="p">:</span> <span class="s2">&quot;cluster001&quot;</span><span class="p">,</span>
  <span class="nt">&quot;consul_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://consul-host:8500&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/lib/viyadb&quot;</span>
<span class="p">}</span>
</pre></div>


<p>Download ViyaDB package, and extract it:</p>
<div class="codehilite"><pre><span></span>curl -sS -L https://github.com/viyadb/viyadb/releases/download/v1.0.0-beta/viyadb-1.0.0-beta-linux-x86_64.tgz <span class="p">|</span> tar -zxf -
</pre></div>


<p>Run ViyaDB instance:</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /opt/viyadb-1.0.0-beta-linux-x86_64
./bin/viyadb /etc/viyadb/store.json
</pre></div>


<h3 id="loading-data">Loading data<a class="headerlink" href="#loading-data" title="Permanent link">&para;</a></h3>
<p>There's utility under <code>bin/</code> directory of ViyaDB package called <code>vsql</code>, which can be used for sending SQL queries to ViyaDB cluster.</p>
<p>Open the SQL shell utility, and connect it to one of ViyaDB hosts:</p>
<div class="codehilite"><pre><span></span>/opt/viyadb-1.0.0-beta-linux-x86_64/bin/vsql viyadb-host <span class="m">5555</span>
</pre></div>


<p>We have 1 billion of user events stored in gzipped TSV format in AWS S3. To load them, issue the following query:</p>
<div class="codehilite"><pre><span></span><span class="n">ViyaDB</span><span class="o">&gt;</span> <span class="k">COPY</span> <span class="n">events</span> <span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">event_time</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">device_vendor</span><span class="p">,</span> <span class="n">ad_network</span><span class="p">,</span> <span class="n">campaign</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">organic</span><span class="p">,</span> <span class="n">days_from_install</span><span class="p">,</span> <span class="n">revenue</span><span class="p">,</span> <span class="k">count</span><span class="p">)</span> <span class="k">FROM</span> <span class="s1">&#39;s3://viyadb-test/events/input/&#39;</span>
</pre></div>


<h3 id="querying">Querying<a class="headerlink" href="#querying" title="Permanent link">&para;</a></h3>
<p>Disclaimer: all queries were recorded when running for the second time to exclude query compilation time from the total query running time.</p>
<p>Count different event types for a given list of applications:</p>
<div class="codehilite"><pre><span></span><span class="n">ViyaDB</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">event_type</span><span class="p">,</span><span class="k">count</span> <span class="k">FROM</span> <span class="n">events</span> <span class="k">WHERE</span> <span class="n">app_id</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;com.skype.raider&#39;</span><span class="p">,</span> <span class="s1">&#39;com.adobe.psmobile&#39;</span><span class="p">,</span> <span class="s1">&#39;com.dropbox.android&#39;</span><span class="p">,</span> <span class="s1">&#39;com.ego360.flatstomach&#39;</span><span class="p">)</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">event_type</span> <span class="k">DESC</span>

<span class="n">event_type</span>  <span class="k">count</span>
<span class="c1">----------  -----</span>
<span class="k">session</span>     <span class="mi">117927202</span>
<span class="n">install</span>     <span class="mi">263444</span>
<span class="n">inappevent</span>  <span class="mi">200466796</span>
<span class="n">impression</span>  <span class="mi">58431</span>
<span class="n">click</span>       <span class="mi">297</span>

<span class="n">Time</span> <span class="n">taken</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">530</span> <span class="n">secs</span>
</pre></div>


<p>Find 5 top cities in USA by install count for a specific application:</p>
<div class="codehilite"><pre><span></span><span class="n">ViyaDB</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">city</span><span class="p">,</span><span class="k">count</span> <span class="k">FROM</span> <span class="n">events</span> <span class="k">WHERE</span> <span class="n">app_id</span><span class="o">=</span><span class="s1">&#39;com.dropbox.android&#39;</span> <span class="k">AND</span> <span class="n">country</span><span class="o">=</span><span class="s1">&#39;US&#39;</span> <span class="k">AND</span> <span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;install&#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">5</span><span class="p">;</span>

<span class="n">city</span>           <span class="k">count</span>
<span class="c1">----           -----</span>
<span class="n">Clinton</span>        <span class="mi">28</span>
<span class="n">Farmington</span>     <span class="mi">20</span>
<span class="n">Madison</span>        <span class="mi">18</span>
<span class="n">Oxford</span>         <span class="mi">18</span>
<span class="n">Highland</span> <span class="n">Park</span>  <span class="mi">18</span>

<span class="n">Time</span> <span class="n">taken</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">171</span> <span class="n">secs</span>
</pre></div>


<p>Find top 10 ad networks for a specific application:</p>
<div class="codehilite"><pre><span></span><span class="n">ViyaDB</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">ad_network</span><span class="p">,</span> <span class="k">count</span> <span class="k">FROM</span> <span class="n">events</span> <span class="k">WHERE</span> <span class="n">app_id</span><span class="o">=</span><span class="s1">&#39;kik.android&#39;</span> <span class="k">AND</span> <span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;install&#39;</span> <span class="k">AND</span> <span class="n">ad_network</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="n">ad_network</span>    <span class="k">count</span>
<span class="c1">----------    -----</span>
<span class="n">Twitter</span>       <span class="mi">1257</span>
<span class="n">Facebook</span>      <span class="mi">1089</span>
<span class="n">Google</span>        <span class="mi">904</span>
<span class="n">jiva_network</span>  <span class="mi">96</span>
<span class="n">yieldlove</span>     <span class="mi">79</span>
<span class="n">i</span><span class="o">-</span><span class="n">movad</span>       <span class="mi">66</span>
<span class="n">barons_media</span>  <span class="mi">57</span>
<span class="n">cpmob</span>         <span class="mi">50</span>
<span class="n">branovate</span>     <span class="mi">35</span>
<span class="n">somimedia</span>     <span class="mi">34</span>

<span class="n">Time</span> <span class="n">taken</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">089</span> <span class="n">secs</span>
</pre></div>


<p>Find user retention (number of distinct user sessions) for the first week, per three major ad networks:</p>
<div class="codehilite"><pre><span></span><span class="n">ViyaDB</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">ad_network</span><span class="p">,</span> <span class="n">days_from_install</span><span class="p">,</span> <span class="n">users</span> <span class="k">FROM</span> <span class="n">events</span> <span class="k">WHERE</span> <span class="n">app_id</span><span class="o">=</span><span class="s1">&#39;kik.android&#39;</span> <span class="k">AND</span> <span class="n">event_time</span> <span class="k">BETWEEN</span> <span class="s1">&#39;2015-01-01&#39;</span> <span class="k">AND</span> <span class="s1">&#39;2015-01-31&#39;</span> <span class="k">AND</span> <span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;session&#39;</span> <span class="k">AND</span> <span class="n">ad_network</span> <span class="k">IN</span><span class="p">(</span><span class="s1">&#39;Facebook&#39;</span><span class="p">,</span> <span class="s1">&#39;Google&#39;</span><span class="p">,</span> <span class="s1">&#39;Twitter&#39;</span><span class="p">)</span> <span class="k">AND</span> <span class="n">days_from_install</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">days_from_install</span><span class="p">,</span> <span class="n">users</span> <span class="k">DESC</span>

<span class="n">ad_network</span>  <span class="n">days_from_install</span>  <span class="n">users</span>
<span class="c1">----------  -----------------  -----</span>
<span class="n">Twitter</span>     <span class="mi">0</span>                  <span class="mi">33</span>
<span class="n">Google</span>      <span class="mi">0</span>                  <span class="mi">20</span>
<span class="n">Facebook</span>    <span class="mi">0</span>                  <span class="mi">14</span>
<span class="n">Twitter</span>     <span class="mi">1</span>                  <span class="mi">31</span>
<span class="n">Google</span>      <span class="mi">1</span>                  <span class="mi">18</span>
<span class="n">Facebook</span>    <span class="mi">1</span>                  <span class="mi">13</span>
<span class="n">Twitter</span>     <span class="mi">2</span>                  <span class="mi">30</span>
<span class="n">Google</span>      <span class="mi">2</span>                  <span class="mi">17</span>
<span class="n">Facebook</span>    <span class="mi">2</span>                  <span class="mi">12</span>
<span class="n">Twitter</span>     <span class="mi">3</span>                  <span class="mi">29</span>
<span class="n">Google</span>      <span class="mi">3</span>                  <span class="mi">14</span>
<span class="n">Facebook</span>    <span class="mi">3</span>                  <span class="mi">11</span>
<span class="n">Twitter</span>     <span class="mi">4</span>                  <span class="mi">27</span>
<span class="n">Google</span>      <span class="mi">4</span>                  <span class="mi">13</span>
<span class="n">Facebook</span>    <span class="mi">4</span>                  <span class="mi">10</span>
<span class="n">Twitter</span>     <span class="mi">5</span>                  <span class="mi">26</span>
<span class="n">Google</span>      <span class="mi">5</span>                  <span class="mi">13</span>
<span class="n">Facebook</span>    <span class="mi">5</span>                  <span class="mi">10</span>
<span class="n">Twitter</span>     <span class="mi">6</span>                  <span class="mi">23</span>
<span class="n">Google</span>      <span class="mi">6</span>                  <span class="mi">12</span>
<span class="n">Facebook</span>    <span class="mi">6</span>                  <span class="mi">9</span>
<span class="n">Twitter</span>     <span class="mi">7</span>                  <span class="mi">22</span>
<span class="n">Google</span>      <span class="mi">7</span>                  <span class="mi">12</span>
<span class="n">Facebook</span>    <span class="mi">7</span>                  <span class="mi">9</span>

<span class="n">Time</span> <span class="n">taken</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">033</span> <span class="n">secs</span>
</pre></div>


<h2 id="real-time-data-processing">Real-Time Data Processing<a class="headerlink" href="#real-time-data-processing" title="Permanent link">&para;</a></h2>
<p>To see the complete real-time data processing architecture based on ViyaDB cluster, please
visit <a href="../realtime/">next</a> section.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../samples/" title="Samples" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Samples
              </span>
            </div>
          </a>
        
        
          <a href="../realtime/" title="Realtime" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Realtime
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/viyadb" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/viyadb" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/18228559" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://groups.google.com/forum/#!forum/viyadb" class="md-footer-social__link fa fa-google"></a>
    
      <a href="mailto:michael@viyadb.com" class="md-footer-social__link fa fa-envelope"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-f3ab9e5ff8.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-23508932-8","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>