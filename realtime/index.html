
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="In-Memory Analytical Database">
      
      
        <link rel="canonical" href="https://viyadb.com/realtime/">
      
      
      
        <link rel="shortcut icon" href="../img/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.10.0">
    
    
      
        <title>Real-time Analytics - ViyaDB</title>
      
    
    
      <script src="../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-b6a6d08807.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-23f75ab9c7.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="blue-grey" data-md-color-accent="cyan">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://viyadb.com" title="ViyaDB" class="md-header-nav__button md-logo">
          
            
              <img src="../img/logo.svg" width="24" height="24">
            
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Real-time Analytics
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/viyadb/viyadb" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      viyadb/viyadb
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        
          <img src="../img/logo.svg">
        
      
    </div>
    ViyaDB
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/viyadb/viyadb" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      viyadb/viyadb
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../usage/" title="Core Usage" class="md-nav__link">
      Core Usage
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../clustering/" title="Setting Up a Cluster" class="md-nav__link">
      Setting Up a Cluster
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Real-time Analytics
      </label>
    
    <a href="./" title="Real-time Analytics" class="md-nav__link md-nav__link--active">
      Real-time Analytics
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#diagram" title="Diagram" class="md-nav__link">
    Diagram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" title="Components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul" title="Consul" class="md-nav__link">
    Consul
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka" title="Kafka" class="md-nav__link">
    Kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deep-store" title="Deep Store" class="md-nav__link">
    Deep Store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer" title="Indexer" class="md-nav__link">
    Indexer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viyadb" title="ViyaDB" class="md-nav__link">
    ViyaDB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" title="Configuration" class="md-nav__link">
    Configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#table-configuration" title="Table configuration" class="md-nav__link">
    Table configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer-configuration" title="Indexer configuration" class="md-nav__link">
    Indexer configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-configuration" title="Cluster configuration" class="md-nav__link">
    Cluster configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#starting-components" title="Starting components" class="md-nav__link">
    Starting components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mobile-user-activity-simulator" title="Mobile user activity simulator" class="md-nav__link">
    Mobile user activity simulator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer-process" title="Indexer process" class="md-nav__link">
    Indexer process
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-cluster" title="Database cluster" class="md-nav__link">
    Database cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying" title="Querying" class="md-nav__link">
    Querying
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#top-10-cities-by-distinct-users-count" title="Top 10 cities by distinct users count" class="md-nav__link">
    Top 10 cities by distinct users count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-retention-query" title="User retention query" class="md-nav__link">
    User retention query
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#work-in-progress" title="Work in progress" class="md-nav__link">
    Work in progress
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../samples/" title="Examples" class="md-nav__link">
      Examples
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#diagram" title="Diagram" class="md-nav__link">
    Diagram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" title="Components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consul" title="Consul" class="md-nav__link">
    Consul
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka" title="Kafka" class="md-nav__link">
    Kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deep-store" title="Deep Store" class="md-nav__link">
    Deep Store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer" title="Indexer" class="md-nav__link">
    Indexer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viyadb" title="ViyaDB" class="md-nav__link">
    ViyaDB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" title="Configuration" class="md-nav__link">
    Configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#table-configuration" title="Table configuration" class="md-nav__link">
    Table configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer-configuration" title="Indexer configuration" class="md-nav__link">
    Indexer configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-configuration" title="Cluster configuration" class="md-nav__link">
    Cluster configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#starting-components" title="Starting components" class="md-nav__link">
    Starting components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mobile-user-activity-simulator" title="Mobile user activity simulator" class="md-nav__link">
    Mobile user activity simulator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer-process" title="Indexer process" class="md-nav__link">
    Indexer process
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-cluster" title="Database cluster" class="md-nav__link">
    Database cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying" title="Querying" class="md-nav__link">
    Querying
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#top-10-cities-by-distinct-users-count" title="Top 10 cities by distinct users count" class="md-nav__link">
    Top 10 cities by distinct users count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-retention-query" title="User retention query" class="md-nav__link">
    User retention query
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#work-in-progress" title="Work in progress" class="md-nav__link">
    Work in progress
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="real-time-architecture">Real-Time Architecture<a class="headerlink" href="#real-time-architecture" title="Permanent link">&para;</a></h1>
<p>This section describes how ViyaDB can be leveraged for building a real-time analytics pipeline,
capable of processing millions of events in a second.</p>
<p>ViyaDB implements shared nothing architecture, which means that workers hold partitions
of data independently from each other. This allows for many possible implementations of
real-time analytics architecture depending on business requirements and/or restrictions
you might have.</p>
<p>Below is one of possible implementations of real-time analytics pipeline based on ViyaDB.</p>
<h2 id="diagram">Diagram<a class="headerlink" href="#diagram" title="Permanent link">&para;</a></h2>
<p><img alt="Real-Time Architecture Example" src="../img/realtime1.png" /></p>
<h2 id="components">Components<a class="headerlink" href="#components" title="Permanent link">&para;</a></h2>
<p>Let's describe all the components of this particular data processing implementation, and how
they help gather insights off of hundreds of thousands of events per second in real-time.</p>
<h3 id="consul">Consul<a class="headerlink" href="#consul" title="Permanent link">&para;</a></h3>
<p>Consul or technologies alike are irreplaceable in any distributed application, where different
components need agree on something. In our case, Consul will be used for two things:</p>
<ul>
<li>Central configuration storage</li>
<li>Coordination of ViyaDB cluster nodes</li>
</ul>
<p>The quickest way to setup Consul is using Docker:</p>
<div class="codehilite"><pre><span></span>docker run --rm -ti --name viyadb-consul -p <span class="m">8500</span>:8500 consul
</pre></div>


<h3 id="kafka">Kafka<a class="headerlink" href="#kafka" title="Permanent link">&para;</a></h3>
<p>Kafka is a de facto standard messaging systeam in the industry for delivering events, thus it was
chosen as the first supported data source. We leverage Kafka also for storing and exchanging various 
metadata between different components.</p>
<p>If you don't have any Kafka, please start one using <a href="https://kafka.apache.org/quickstart">Kafka Quickstart</a> documentation.</p>
<h3 id="deep-store">Deep Store<a class="headerlink" href="#deep-store" title="Permanent link">&para;</a></h3>
<p>Deep Store is a place on some kind of distributed file system or object store for keeping Indexer results.
In fact, the copy of all the data is always stored there, which facilitates data repair and data recovery.</p>
<div class="admonition note">
<p class="admonition-title">File systems support</p>
<p>For now, only POSIX-compilant file systems and Amazon S3 are supported.</p>
</div>
<h3 id="indexer">Indexer<a class="headerlink" href="#indexer" title="Permanent link">&para;</a></h3>
<p>This component consists of two sub-components:</p>
<ul>
<li>Real-time processor</li>
<li>Batch processor</li>
</ul>
<p>The first component represents Spark Streaming based application whose task is to read events
from Kafka, and pre-aggregate them into micro-batches for loading into ViyaDB.
The second part is invoked periodically, and it aims at compacting previous micro-batches
and creating the best data partitioning plan.</p>
<p>Spark cluster is required for running the Indexer at high scale. For testing purposes it's enough to just download
and extract latest <a href="https://spark.apache.org/downloads.html">Apache Spark</a> package.</p>
<p>To read more about the Indexer, please refer to the <a href="https://github.com/viyadb/viyadb-spark">README</a> file
of the project.</p>
<h3 id="viyadb">ViyaDB<a class="headerlink" href="#viyadb" title="Permanent link">&para;</a></h3>
<p>This is the database cluster itself. Every physical node of the cluster consists of supervisor process,
which spawns worker processes by the number of available CPU. Node controller running on every node
deals with loading data into worker processes. In addition, controller also redirects database queries to 
a worker node containing required data partition, based on query filter (or queries needed workers,
and aggregates results).</p>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<h3 id="table-configuration">Table configuration<a class="headerlink" href="#table-configuration" title="Permanent link">&para;</a></h3>
<p>This configuration defines database table structure, what event fields represent dimensions,
and which ones are metrics. See <a href="../usage/#creating-tables">Creating Tables</a> section for more
on table configuration.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;events&quot;</span><span class="p">,</span>
  <span class="nt">&quot;dimensions&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;app_id&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint&quot;</span><span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;event_time&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
      <span class="nt">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;millis&quot;</span><span class="p">,</span> <span class="nt">&quot;granularity&quot;</span><span class="p">:</span> <span class="s2">&quot;day&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;country&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;city&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;device_type&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;device_vendor&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ad_network&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;campaign&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;site_id&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;event_type&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;event_name&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;organic&quot;</span><span class="p">,</span> <span class="nt">&quot;cardinality&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;days_from_install&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ushort&quot;</span><span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;revenue&quot;</span> <span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;double_sum&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bitset&quot;</span><span class="p">,</span> <span class="nt">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="nt">&quot;max&quot;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">},</span>
    <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span> <span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>To load this configuration into Consul, store this JSON in file <code>table.json</code>, and run:</p>
<div class="codehilite"><pre><span></span>curl --request PUT --data @table.json <span class="se">\</span>
  http://&lt;consul-host&gt;:8500/v1/kv/viyadb/tables/events/config
</pre></div>


<h3 id="indexer-configuration">Indexer configuration<a class="headerlink" href="#indexer-configuration" title="Permanent link">&para;</a></h3>
<p>The following section tells Indexer where to read data from, what's the data format
(supported formats are: JSON, CSV), what are micro-batch and big batch window sizes, etc.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;tables&quot;</span><span class="p">:[</span>
    <span class="s2">&quot;events&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;deepStorePath&quot;</span><span class="p">:</span><span class="s2">&quot;s3://viyadb-deepstore&quot;</span><span class="p">,</span>
  <span class="nt">&quot;realTime&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;windowDuration&quot;</span><span class="p">:</span><span class="s2">&quot;PT15S&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kafkaSource&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;topics&quot;</span><span class="p">:[</span>
        <span class="s2">&quot;events&quot;</span>
      <span class="p">],</span>
      <span class="nt">&quot;brokers&quot;</span><span class="p">:[</span>
        <span class="s2">&quot;kafka-host:9092&quot;</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;parseSpec&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="s2">&quot;json&quot;</span><span class="p">,</span>
      <span class="nt">&quot;timeColumn&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;event_time&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;notifier&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;kafka&quot;</span><span class="p">,</span>
      <span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;kafka-host:9092&quot;</span><span class="p">,</span>
      <span class="nt">&quot;queue&quot;</span><span class="p">:</span><span class="s2">&quot;rt-notifications&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;batch&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;partitioning&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;columns&quot;</span><span class="p">:[</span>
        <span class="s2">&quot;app_id&quot;</span>
      <span class="p">],</span>
      <span class="nt">&quot;partitions&quot;</span><span class="p">:</span><span class="mi">16</span>
    <span class="p">},</span>
    <span class="nt">&quot;notifier&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;kafka&quot;</span><span class="p">,</span>
      <span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;kafka-host:9092&quot;</span><span class="p">,</span>
      <span class="nt">&quot;queue&quot;</span><span class="p">:</span><span class="s2">&quot;batch-notifications&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Replace <code>kafka-host:9090</code> with comma separated list of your actual Kafka brokers.
To load this configuration into Consul, store this JSON in file <code>indexer.json</code>, and run:</p>
<div class="codehilite"><pre><span></span>curl --request PUT --data @indexer.json <span class="se">\</span>
  http://&lt;consul-host&gt;:8500/v1/kv/viyadb/indexers/main/config
</pre></div>


<h3 id="cluster-configuration">Cluster configuration<a class="headerlink" href="#cluster-configuration" title="Permanent link">&para;</a></h3>
<p>This configuration tells ViyaDB controller what tables to create, and which indexers to pull
the data from.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;replication_factor&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;workers&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
  <span class="nt">&quot;tables&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">],</span>
  <span class="nt">&quot;indexers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>Currently, the number of expected workers must be set explicitly in cluster configuration.
This is the total number of nodes multiplied by the number of CPU cores on each machine.
Using this configuration, two copies of a single partition will be placed on two different workers.</p>
<p>To load this configuration into Consul, store this JSON in file <code>cluster.json</code>, and run:</p>
<div class="codehilite"><pre><span></span>curl --request PUT --data @cluster.json <span class="se">\</span>
  http://&lt;consul-host&gt;:8500/v1/kv/viyadb/clusters/cluster001/config
</pre></div>


<h2 id="starting-components">Starting components<a class="headerlink" href="#starting-components" title="Permanent link">&para;</a></h2>
<h3 id="mobile-user-activity-simulator">Mobile user activity simulator<a class="headerlink" href="#mobile-user-activity-simulator" title="Permanent link">&para;</a></h3>
<p>Let's run a simulator, which will inject some synthetic data representing mobile app
user activity into Kafka:</p>
<div class="codehilite"><pre><span></span>docker run --log-driver<span class="o">=</span>none --rm -ti viyadb/events-generator:latest <span class="p">|</span> <span class="se">\</span>
  kafka-console-producer.sh --broker-list &lt;kafka-host&gt;:9092 <span class="se">\</span>
  --topic events &gt;/dev/null
</pre></div>


<h3 id="indexer-process">Indexer process<a class="headerlink" href="#indexer-process" title="Permanent link">&para;</a></h3>
<p>Once the configuration part is done, we can start the Indexer process. The following
command is tuned for running Indexer in a limited Spark local mode environment,
please tune it according to your Spark cluster capacity and events rate.</p>
<div class="codehilite"><pre><span></span>wget -q <span class="se">\</span>
  https://github.com/viyadb/viyadb-spark/releases/download/v0.0.2/viyadb-spark_2.11-0.0.2-uberjar.jar

spark-submit --executor-memory 2G <span class="se">\</span>
  --conf spark.streaming.kafka.maxRatePerPartition<span class="o">=</span><span class="m">10000</span> <span class="se">\</span>
  --conf spark.sql.shuffle.partitions<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
  --class com.github.viyadb.spark.streaming.Job <span class="se">\</span>
  viyadb-spark_2.11-0.0.2-uberjar.jar <span class="se">\</span>
  --indexer-id <span class="s2">&quot;main&quot;</span>
</pre></div>


<h3 id="database-cluster">Database cluster<a class="headerlink" href="#database-cluster" title="Permanent link">&para;</a></h3>
<p>Now it's the time to start ViyaDB cluster. Repeat the following procedure for every
node (we'll start 4 nodes):</p>
<div class="codehilite"><pre><span></span>mkdir /tmp/viyadb
cat &gt;/tmp/viyadb/conf.json <span class="s">&lt;&lt;EOF</span>
<span class="s">{</span>
<span class="s">  &quot;supervise&quot;: true,</span>
<span class="s">  &quot;workers&quot;: 8,</span>
<span class="s">  &quot;cluster_id&quot;: &quot;cluster001&quot;,</span>
<span class="s">  &quot;consul_url&quot;: &quot;http://consul-host:8500&quot;,</span>
<span class="s">  &quot;state_dir&quot;: &quot;/var/lib/viyadb&quot;</span>
<span class="s">}</span>
<span class="s">EOF</span>

docker run --rm -ti <span class="se">\</span>
  -p <span class="m">5000</span>-5007:5000-5007 <span class="se">\</span>
  -p <span class="m">5555</span>:5555 <span class="se">\</span>
  -v /tmp/viyadb:/var/lib/viyadb:rw <span class="se">\</span>
  viyadb/viyadb:latest <span class="se">\</span>
  /opt/viyadb/bin/viyad /var/lib/viyadb/conf.json
</pre></div>


<h2 id="querying">Querying<a class="headerlink" href="#querying" title="Permanent link">&para;</a></h2>
<p>Once all components are started and running, we can start sending some queries.</p>
<p>Multiple options to query ViyaDB exist, such as <a href="../usage/#querying">REST API</a>
or <a href="https://github.com/viyadb/zeppelin-interpreter">Zeppelin</a> interpreter,
but we'll just use SQL shell for this test.</p>
<p>Start the shell, and provide it with a hostname of one of ViyaDB cluster nodes,
and a controller port number:</p>
<div class="codehilite"><pre><span></span>docker run --rm -ti viyadb/viyadb:latest <span class="se">\</span>
  /opt/viyadb/bin/vsql viyadb-host <span class="m">5555</span>
</pre></div>


<h3 id="top-10-cities-by-distinct-users-count">Top 10 cities by distinct users count<a class="headerlink" href="#top-10-cities-by-distinct-users-count" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>ViyaDB&gt; SELECT city, users FROM events WHERE <span class="nv">app_id</span><span class="o">=</span><span class="s1">&#39;kik.android&#39;</span> and city &lt;&gt; <span class="s1">&#39;&#39;</span> ORDER BY users DESC LIMIT <span class="m">10</span><span class="p">;</span>

city               users
----               -----
Kowloon            <span class="m">76</span>
Tsuen Wan          <span class="m">74</span>
Yuen Long Kau Hui  <span class="m">70</span>
Hong Kong          <span class="m">67</span>
Azur               <span class="m">9</span>
Qiryat Ono         <span class="m">9</span>
Tayibe             <span class="m">9</span>
Ganne Tiqwa        <span class="m">8</span>
Sederot            <span class="m">7</span>
Abu Ghosh          <span class="m">7</span>

Time taken: <span class="m">0</span>.012320 secs
</pre></div>


<h3 id="user-retention-query">User retention query<a class="headerlink" href="#user-retention-query" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>ViyaDB&gt; SELECT ad_network, days_from_install, users FROM events WHERE <span class="nv">app_id</span><span class="o">=</span><span class="s1">&#39;kik.android&#39;</span> AND event_time BETWEEN <span class="s1">&#39;2015-01-01&#39;</span> AND <span class="s1">&#39;2015-01-31&#39;</span> AND <span class="nv">event_type</span><span class="o">=</span><span class="s1">&#39;session&#39;</span> AND ad_network IN<span class="o">(</span><span class="s1">&#39;Facebook&#39;</span>, <span class="s1">&#39;Google&#39;</span>, <span class="s1">&#39;Twitter&#39;</span><span class="o">)</span> ORDER BY days_from_install<span class="p">;</span>

ad_network  days_from_install  users
----------  -----------------  -----
Twitter     <span class="m">0</span>                  <span class="m">573</span>
Google      <span class="m">0</span>                  <span class="m">623</span>
Facebook    <span class="m">0</span>                  <span class="m">595</span>
Google      <span class="m">1</span>                  <span class="m">427</span>
Facebook    <span class="m">1</span>                  <span class="m">410</span>
Twitter     <span class="m">1</span>                  <span class="m">398</span>
Twitter     <span class="m">2</span>                  <span class="m">263</span>
Google      <span class="m">2</span>                  <span class="m">250</span>
Facebook    <span class="m">2</span>                  <span class="m">253</span>
Twitter     <span class="m">3</span>                  <span class="m">112</span>
Facebook    <span class="m">3</span>                  <span class="m">105</span>
Google      <span class="m">3</span>                  <span class="m">106</span>
Twitter     <span class="m">4</span>                  <span class="m">9</span>
Facebook    <span class="m">4</span>                  <span class="m">8</span>
Google      <span class="m">4</span>                  <span class="m">12</span>

Time taken: <span class="m">0</span>.057661 secs
</pre></div>


<h2 id="work-in-progress">Work in progress<a class="headerlink" href="#work-in-progress" title="Permanent link">&para;</a></h2>
<p>This is just the beginning, and most functionality like cluster management and monitoring is still missing,
but we're working on it.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../clustering/" title="Setting Up a Cluster" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Setting Up a Cluster
              </span>
            </div>
          </a>
        
        
          <a href="../samples/" title="Examples" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Examples
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/viyadb" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/viyadb" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/18228559" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://groups.google.com/forum/#!forum/viyadb" class="md-footer-social__link fa fa-google"></a>
    
      <a href="mailto:michael@viyadb.com" class="md-footer-social__link fa fa-envelope"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-f3ab9e5ff8.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
        <script src="../js/extra.js"></script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-23508932-8","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>